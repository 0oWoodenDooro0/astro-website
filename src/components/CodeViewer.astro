---
interface Props {
  initialCode?: string;
  initialHighlighted?: string;
  initialFilename?: string;
}

const { 
  initialCode = '', 
  initialHighlighted = '', 
  initialFilename = 'Select a file' 
} = Astro.props;
---

<div class="code-viewer-container border border-ctp-surface0 rounded-xl overflow-hidden bg-ctp-crust shadow-2xl font-mono h-full flex flex-col">
  <div class="bg-ctp-mantle px-4 py-3 border-b border-ctp-surface0 flex items-center justify-between flex-shrink-0">
    <div class="flex items-center gap-3">
      <div class="flex gap-1.5">
        <div class="w-3 h-3 rounded-full bg-ctp-red/50"></div>
        <div class="w-3 h-3 rounded-full bg-ctp-yellow/50"></div>
        <div class="w-3 h-3 rounded-full bg-ctp-green/50"></div>
      </div>
      <span id="viewer-filename" class="text-xs text-ctp-overlay1 ml-2 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
        {initialFilename}
      </span>
    </div>
    <button
      id="copy-button"
      class="text-ctp-overlay1 hover:text-ctp-pink transition-colors p-1 rounded"
      title="Copy to clipboard"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
    </button>
  </div>
  
  <div id="code-content" class="p-0 text-sm relative overflow-auto flex-grow">
    {initialHighlighted ? (
      <Fragment set:html={initialHighlighted} />
    ) : (
      <div class="p-8 text-ctp-overlay0 text-center italic">
        Select a file from the tree to view its content.
      </div>
    )}
  </div>
</div>

<script>
  import { $selectedFile } from '../lib/stores';

  let currentCode = '';

  const copyButton = document.getElementById('copy-button');
  const filenameEl = document.getElementById('viewer-filename');
  const contentEl = document.getElementById('code-content');

  $selectedFile.subscribe((file) => {
    if (file && filenameEl && contentEl) {
      currentCode = file.content;
      
      filenameEl.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
        ${file.name}
      `;
      
      contentEl.innerHTML = file.highlightedContent;
    }
  });

  copyButton?.addEventListener('click', () => {
    if (!currentCode) return;
    
    navigator.clipboard.writeText(currentCode);
    const originalIcon = copyButton.innerHTML;
    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
    setTimeout(() => {
      copyButton.innerHTML = originalIcon;
    }, 2000);
  });
</script>

<style is:global>
  .code-viewer-container pre {
    background-color: transparent !important;
    padding: 1rem !important;
    margin: 0 !important;
    overflow-x: auto;
    line-height: 1 !important;
  }
  .code-viewer-container code {
    counter-reset: line;
  }
  .code-viewer-container .line {
    display: block;
    line-height: 1 !important;
  }
  .code-viewer-container .line::before {
    counter-increment: line;
    content: counter(line);
    display: inline-block;
    width: 2rem;
    margin-right: 1.25rem;
    text-align: right;
    color: var(--ctp-surface2);
    user-select: none;
  }
</style>
